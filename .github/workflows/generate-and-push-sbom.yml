name: üßæ Generate and Push SBOMs to SBOM Manager

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - feature/sbom

env:
  TOKEN: ${{ secrets.SBOM_PUSH_TOKEN }}   
  PROJECT_NAME: python-project            # üëà Change this to match your project folder name inside sbom-manager

jobs:
  sbom-generate-push:
    name: Generate and Push SBOMs
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout source code
      # -----------------------------------------------------------
      - name: üß© Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python
      # -----------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # -----------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Install cdxgen
      # -----------------------------------------------------------
      - name: ‚öôÔ∏è Install cdxgen
        run: |
          echo "üì¶ Installing CycloneDX Generator (cdxgen)..."
          npm install -g @cyclonedx/cdxgen@10.10.3
          echo "‚úÖ Installed cdxgen version: $(cdxgen --version)"

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Generate Application SBOM
      # -----------------------------------------------------------
      - name: üßæ Generate Application SBOM
        run: |
          echo "üîç Generating Python SBOM using cdxgen..."
          cdxgen -t python -r -o app-sbom.cdx.json
          echo "‚úÖ Application SBOM created ‚Üí $(pwd)/app-sbom.cdx.json"

      # -----------------------------------------------------------
      # 6Ô∏è‚É£ Build Docker image
      # -----------------------------------------------------------
      - name: üèóÔ∏è Build Docker image
        run: |
          docker build -t $PROJECT_NAME:latest .
          echo "‚úÖ Docker image built successfully."

      # -----------------------------------------------------------
      # 7Ô∏è‚É£ Install Trivy
      # -----------------------------------------------------------
      - name: üîß Install Trivy
        run: |
          TRIVY_VER=$(curl -sSL https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          curl -sfL "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VER}/trivy_${TRIVY_VER#v}_Linux-64bit.tar.gz" | tar -xz -C /tmp
          sudo mv /tmp/trivy /usr/local/bin/trivy
          trivy --version

      # -----------------------------------------------------------
      # 8Ô∏è‚É£ Generate Container SBOM
      # -----------------------------------------------------------
      - name: üß± Generate Container SBOM
        run: |
          echo "üîç Generating container SBOM..."
          trivy image --format cyclonedx --list-all-pkgs --output container-sbom.cdx.json $PROJECT_NAME:latest
          echo "‚úÖ Container SBOM created ‚Üí $(pwd)/container-sbom.cdx.json"

      # -----------------------------------------------------------
      # 9Ô∏è‚É£ Upload SBOMs as Artifacts (optional)
      # -----------------------------------------------------------
      - name: üì§ Upload SBOMs as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-sboms
          path: |
            app-sbom.cdx.json
            container-sbom.cdx.json

      # -----------------------------------------------------------
      # üîü Push SBOMs to sbom-manager repo
      # -----------------------------------------------------------
      - name: üöÄ Push SBOMs to sbom-manager repo
        run: |
          set -euo pipefail
          echo "üì¶ Cloning sbom-manager repo..."
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

          git clone https://x-access-token:${TOKEN}@github.com/mrpraveenpr/SBOM-Manager.git
          cd SBOM-Manager

          # Create project folder if missing
          mkdir -p sboms/${PROJECT_NAME}

          # Move new SBOMs
          cp ../app-sbom.cdx.json sboms/${PROJECT_NAME}/
          cp ../container-sbom.cdx.json sboms/${PROJECT_NAME}/

          echo "üíæ Commit and push SBOMs..."
          git add sboms/${PROJECT_NAME}/
          git commit -m "üîÑ Update SBOMs for ${PROJECT_NAME} - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin main
          echo "‚úÖ SBOMs successfully pushed to sbom-manager/${PROJECT_NAME}"
