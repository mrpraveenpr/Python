name: üßæ Generate and Push SBOMs to SBOM Manager

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - feature/sbom

permissions:
  contents: write   # ‚úÖ required for pushing via GITHUB_TOKEN

env:
  PROJECT_NAME: python-project

jobs:
  sbom-generate-push:
    name: Generate and Push SBOMs
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout source code
      # -----------------------------------------------------------
      - name: üß© Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Setup Python
      # -----------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Install system dependencies
      # -----------------------------------------------------------
      - name: üß∞ Install required system libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3-opencv tesseract-ocr libgl1 libglib2.0-0 \
            ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev

      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Install Python dependencies
      # -----------------------------------------------------------
      - name: üì¶ Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            echo "üì¶ Installing Python dependencies..."
            pip install --upgrade pip setuptools wheel
            pip install --no-cache-dir -r requirements.txt || echo "‚ö†Ô∏è Some optional packages failed to install, continuing..."
          else
            echo "‚ö†Ô∏è No requirements.txt found ‚Äî skipping Python dependency install."
          fi

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Install cdxgen
      # -----------------------------------------------------------
      - name: ‚öôÔ∏è Install cdxgen
        run: |
          echo "üì¶ Installing CycloneDX Generator (cdxgen)..."
          npm install -g @cyclonedx/cdxgen@10.10.3
          echo "‚úÖ Installed cdxgen version: $(cdxgen --version)"

      # -----------------------------------------------------------
      # 6Ô∏è‚É£ Generate Application SBOM
      # -----------------------------------------------------------
      - name: üßæ Generate Application SBOM
        run: |
          echo "üîç Generating Python SBOM using cdxgen..."
          cdxgen -t python -r -o app-sbom.cdx.json || echo "‚ö†Ô∏è SBOM generation failed, continuing..."
          if [ -f app-sbom.cdx.json ]; then
            echo "‚úÖ Application SBOM created ‚Üí $(pwd)/app-sbom.cdx.json"
          else
            echo "‚ùå Failed to create application SBOM"; exit 1
          fi

      # -----------------------------------------------------------
      # 7Ô∏è‚É£ Conditional Docker build (skip if no Dockerfile)
      # -----------------------------------------------------------
      - name: üèóÔ∏è Build Docker image (if Dockerfile exists)
        run: |
          if [ -f "Dockerfile" ]; then
            echo "üê≥ Dockerfile found. Building image for $PROJECT_NAME..."
            docker build -t $PROJECT_NAME:latest .
            echo "‚úÖ Docker image built successfully."
          else
            echo "‚ö†Ô∏è No Dockerfile found ‚Äî skipping Docker build."
          fi

      # -----------------------------------------------------------
      # 8Ô∏è‚É£ Install Trivy
      # -----------------------------------------------------------
      - name: üîß Install Trivy
        run: |
          echo "üì¶ Installing Trivy..."
          TRIVY_VER=$(curl -sSL https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          curl -sfL "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VER}/trivy_${TRIVY_VER#v}_Linux-64bit.tar.gz" | tar -xz -C /tmp
          sudo mv /tmp/trivy /usr/local/bin/trivy
          echo "‚úÖ Trivy version: $(trivy --version)"

      # -----------------------------------------------------------
      # 9Ô∏è‚É£ Generate Container SBOM (only if image exists)
      # -----------------------------------------------------------
      - name: üß± Generate Container SBOM (safe mode)
        run: |
          if docker image inspect $PROJECT_NAME:latest > /dev/null 2>&1; then
            echo "üîç Generating container SBOM..."
            trivy image --format cyclonedx --output container-sbom.cdx.json $PROJECT_NAME:latest || echo "‚ö†Ô∏è Container SBOM generation failed, continuing..."
            if [ -f container-sbom.cdx.json ]; then
              echo "‚úÖ Container SBOM created ‚Üí $(pwd)/container-sbom.cdx.json"
            else
              echo "‚ö†Ô∏è No container SBOM created."
            fi
          else
            echo "‚ö†Ô∏è No Docker image found ‚Äî skipping container SBOM."
          fi

      # -----------------------------------------------------------
      # üîü Upload SBOMs as Artifacts
      # -----------------------------------------------------------
      - name: üì§ Upload SBOMs as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-sboms
          path: |
            app-sbom.cdx.json
            container-sbom.cdx.json

      # -----------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Push SBOMs to sbom-manager repo (with built-in token)
      # -----------------------------------------------------------
      - name: üöÄ Push SBOMs to sbom-manager repo
        run: |
          set -euo pipefail
          echo "üì¶ Cloning SBOM Manager repo..."
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

          # ‚úÖ Use GITHUB_TOKEN for authentication
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/mrpraveenpr/SBOM-Manager.git
          cd SBOM-Manager

          mkdir -p sboms/${PROJECT_NAME}

          echo "üì§ Copying SBOMs to SBOM Manager folder..."
          cp ../app-sbom.cdx.json sboms/${PROJECT_NAME}/ || echo "‚ö†Ô∏è Missing app-sbom.cdx.json"
          [ -f ../container-sbom.cdx.json ] && cp ../container-sbom.cdx.json sboms/${PROJECT_NAME}/ || echo "‚ö†Ô∏è Skipping container SBOM (not found)."

          echo "üíæ Committing and pushing SBOM updates..."
          git add sboms/${PROJECT_NAME}/
          git commit -m "üîÑ Update SBOMs for ${PROJECT_NAME} - $(date +'%Y-%m-%d %H:%M:%S')" || echo "‚ÑπÔ∏è No new changes to commit"
          git push origin main
          echo "‚úÖ SBOMs successfully pushed to sbom-manager/${PROJECT_NAME}"
